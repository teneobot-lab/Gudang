<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web to Warehouse | Ultimate Fix</title>
    <style>
        /* --- VARIABLES --- */
        :root {
            --bg-deep: #020617;
            --bg-glass: rgba(15, 23, 42, 0.7); 
            --bg-input: rgba(255, 255, 255, 0.05); 
            --primary: #38bdf8;
            --primary-grad: linear-gradient(135deg, #38bdf8 0%, #2563eb 100%);
            --border: rgba(255, 255, 255, 0.08);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --font: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body {
            font-family: var(--font);
            background-color: var(--bg-deep);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- BACKGROUND --- */
        .scene {
            position: fixed; top:0; left:0; width:100%; height:100%; z-index:0;
            background: radial-gradient(circle at 50% 50%, #1e293b 0%, #020617 100%);
            overflow: hidden;
        }
        .cube {
            position: absolute; border: 1px solid rgba(56, 189, 248, 0.15);
            background: rgba(56, 189, 248, 0.03); backdrop-filter: blur(2px);
            border-radius: 8px; 
            animation: float 25s infinite linear;
        }
        @keyframes float { 0%{transform:translateY(100vh) rotate(0deg)} 100%{transform:translateY(-20vh) rotate(360deg)} }

        /* --- UI COMPONENTS --- */
        .glass {
            background: var(--bg-glass); backdrop-filter: blur(16px);
            border: 1px solid var(--border); border-radius: var(--radius);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .btn {
            background: var(--primary-grad); color: white; border: none;
            padding: 8px 16px; border-radius: 8px; cursor: pointer;
            font-size: 0.85rem; font-weight: 600; transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn:hover:not(:disabled) { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3); }
        .btn:disabled { filter: grayscale(1); cursor: not-allowed; opacity: 0.5; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        .btn-ghost:hover { border-color: var(--primary); color: var(--text-main); background: rgba(56, 189, 248, 0.1); }
        .btn-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.3); }
        .btn-sm { padding: 4px 10px; font-size: 0.75rem; border-radius: 6px; }

        input, select, textarea {
            background: var(--bg-input); border: 1px solid var(--border);
            color: var(--text-main); padding: 8px 12px;
            border-radius: 8px; font-family: var(--font); font-size: 0.9rem;
            width: 100%; transition: 0.2s;
        }
        input:focus, select:focus { border-color: var(--primary); background: rgba(255,255,255,0.08); }
        input[readonly] { background: rgba(255,255,255,0.02); cursor: default; opacity: 0.7; }
        
        /* --- LAYOUT --- */
        .app { display: flex; flex-direction: column; height: 100%; position: relative; z-index: 10; }
        
        nav {
            padding: 0 2rem; height: 70px; display: flex; align-items: center; justify-content: space-between;
            background: rgba(2, 6, 23, 0.95); border-bottom: 1px solid var(--border);
        }
        .brand { font-weight: 700; letter-spacing: 1px; display: flex; align-items: center; gap: 10px; font-size: 1.1rem;}
        .brand svg { color: var(--primary); }

        .tabs { display: flex; gap: 8px; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 12px; }
        .tab {
            padding: 8px 20px; border-radius: 10px; cursor: pointer; font-size: 0.85rem;
            color: var(--text-muted); transition: 0.3s; font-weight: 500;
        }
        .tab:hover { color: var(--text-main); background: rgba(255,255,255,0.05); }
        .tab.active { background: var(--primary-grad); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        main { flex: 1; padding: 2rem; overflow-y: auto; }
        .section-title { font-size: 1.4rem; margin-bottom: 1.5rem; font-weight: 300; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
        .hidden { display: none !important; }

        /* Tables */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: transparent; color: var(--text-muted); text-align: left; padding: 12px 10px; font-size: 0.75rem; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        td { padding: 12px 10px; border-bottom: 1px solid var(--border); color: var(--text-main); }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.03); }

        /* Form Grids */
        .f-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .f-label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Autocomplete */
        .ac-wrap { position: relative; }
        .ac-list {
            position: absolute; top: 100%; left: 0; right: 0; z-index: 50;
            background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(10px); border-radius: 12px;
            border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-height: 200px; overflow-y: auto; display: none; margin-top: 5px;
        }
        .ac-list div { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.02); }
        .ac-list div:hover { background: var(--primary-grad); color: white; }
        .ac-list div:last-child { border-bottom: none; border-radius: 0 0 12px 12px; }

        /* Stock Info */
        .st-info { font-size: 0.8rem; margin-top: 8px; padding: 8px; border-radius: 8px; background: rgba(255,255,255,0.03); }
        .st-info.good { color: var(--success); background: rgba(16, 185, 129, 0.1); }
        .st-info.bad { color: var(--danger); background: rgba(239, 68, 68, 0.1); }

        /* Unit Tag */
        .unit-tag { 
            display: inline-flex; align-items: center; background: rgba(56, 189, 248, 0.1); 
            padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; margin-right: 6px; margin-bottom: 6px; 
            border: 1px solid rgba(56,189,248,0.2); color: var(--primary);
        }

        /* Toast */
        #toast-box { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast {
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-left: 4px solid var(--primary); color: white;
            padding: 12px 20px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-size: 0.9rem; pointer-events: auto;
        }
        @keyframes slideIn { from{transform:translateX(100%); opacity:0;} to{transform:translateX(0); opacity:1;} }
    </style>
</head>
<body>

    <!-- BACKGROUND -->
    <div class="scene" id="bg-scene"></div>
    <div id="toast-box"></div>

    <!-- LOGIN -->
    <div id="login-screen" style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:200; background:var(--bg-deep); display:flex; justify-content:center; align-items:center;">
        <div class="glass" style="padding:40px; width:380px; text-align:center;">
            <h2 style="margin-bottom:25px; color:var(--primary); letter-spacing: 2px;">W2W ULTIMATE</h2>
            <form id="login-form">
                <div style="margin-bottom:15px; text-align:left;">
                    <label class="f-label">Username</label>
                    <input type="text" id="l-user" value="admin">
                </div>
                <div style="margin-bottom:25px; text-align:left;">
                    <label class="f-label">Password</label>
                    <input type="password" id="l-pass" value="admin">
                </div>
                <button type="submit" class="btn" style="width:100%; justify-content:center; font-size:1rem; padding:10px;">LOGIN SYSTEM</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="app hidden" id="app-main">
        <nav>
            <div class="brand">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                W2W SYSTEM
            </div>
            <div class="tabs">
                <div class="tab active" data-t="dashboard">Dashboard</div>
                <div class="tab" data-t="incoming">Barang Masuk</div>
                <div class="tab" data-t="outgoing">Barang Keluar</div>
                <div class="tab" data-t="stockopname">Stock Opname</div>
                <div class="tab" data-t="history">Riwayat</div>
                <div class="tab" data-t="suppliers">Supplier</div>
                <div class="tab" data-t="admin">Master Data</div>
            </div>
            <div style="font-size:0.85rem; color:var(--text-muted); font-weight:500;" id="u-display">User</div>
        </nav>

        <main>
            <!-- DASHBOARD -->
            <section id="v-dashboard">
                <h3 class="section-title">Overview</h3>
                <div class="f-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="glass" style="padding:20px; text-align:center;">
                        <div class="f-label">Total Items</div>
                        <div style="font-size:2.5rem; font-weight:700; color:var(--primary);" id="d-items">0</div>
                    </div>
                    <div class="glass" style="padding:20px; text-align:center;">
                        <div class="f-label">Total Stock</div>
                        <div style="font-size:2.5rem; font-weight:700; color:var(--text-main);" id="d-stock">0</div>
                    </div>
                    <div class="glass" style="padding:20px; text-align:center;">
                        <div class="f-label">Low Stock</div>
                        <div style="font-size:2.5rem; font-weight:700; color:var(--warning);" id="d-low">0</div>
                    </div>
                    <div class="glass" style="padding:20px; text-align:center;">
                        <div class="f-label">Tx Today</div>
                        <div style="font-size:2.5rem; font-weight:700; color:var(--success);" id="d-tx">0</div>
                    </div>
                </div>
            </section>

            <!-- INCOMING -->
            <section id="v-incoming" class="hidden">
                <h3 class="section-title">Barang Masuk</h3>
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px;">
                    <div class="glass" style="padding:20px;">
                        <div class="f-grid">
                            <div><label class="f-label">Tanggal</label><input type="date" id="in-date"></div>
                            <div><label class="f-label">Supplier</label><select id="in-supp"></select></div>
                            <div><label class="f-label">Ref No</label><input type="text" id="in-ref"></div>
                        </div>
                        
                        <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid var(--border);">
                            <div class="f-grid" style="grid-template-columns: 3fr 140px 100px auto;">
                                <div class="ac-wrap">
                                    <label class="f-label">Cari Barang (Enter)</label>
                                    <input type="text" id="in-search" placeholder="Ketik nama..." autocomplete="off">
                                    <div class="ac-list" id="in-list"></div>
                                </div>
                                <div>
                                    <label class="f-label">Satuan</label>
                                    <select id="in-unit"></select>
                                </div>
                                <div>
                                    <label class="f-label">Qty</label>
                                    <input type="number" id="in-qty" value="1" min="1">
                                </div>
                                <div style="display:flex; align-items:flex-end;">
                                    <button type="button" class="btn" id="btn-add-in">Add</button>
                                </div>
                            </div>
                            <div id="in-info" class="st-info">Stok saat ini: -</div>
                        </div>
                    </div>
                    
                    <div class="glass" style="padding:20px; display:flex; flex-direction:column;">
                        <label class="f-label">Keranjang Transaksi</label>
                        <div class="table-wrap" style="flex:1; max-height:350px; overflow-y:auto;">
                            <table>
                                <thead><tr><th>Item</th><th>Qty</th><th>Unit</th><th></th></tr></thead>
                                <tbody id="in-cart"></tbody>
                            </table>
                        </div>
                        <button type="button" class="btn" id="btn-save-in" style="width:100%; margin-top:15px; justify-content:center; font-size:1rem;">Simpan Transaksi</button>
                    </div>
                </div>
            </section>

            <!-- OUTGOING -->
            <section id="v-outgoing" class="hidden">
                <h3 class="section-title">Barang Keluar</h3>
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px;">
                    <div class="glass" style="padding:20px;">
                        <div class="f-grid">
                            <div><label class="f-label">Tanggal</label><input type="date" id="out-date"></div>
                            <div style="grid-column:span 2"><label class="f-label">Tujuan/Ket</label><input type="text" id="out-dest"></div>
                        </div>
                        
                        <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid var(--border);">
                            <div class="f-grid" style="grid-template-columns: 3fr 140px 100px auto;">
                                <div class="ac-wrap">
                                    <label class="f-label">Cari Barang (Enter)</label>
                                    <input type="text" id="out-search" placeholder="Ketik nama..." autocomplete="off">
                                    <div class="ac-list" id="out-list"></div>
                                </div>
                                <div>
                                    <label class="f-label">Satuan</label>
                                    <select id="out-unit"></select>
                                </div>
                                <div>
                                    <label class="f-label">Qty</label>
                                    <input type="number" id="out-qty" value="1" min="1">
                                </div>
                                <div style="display:flex; align-items:flex-end;">
                                    <button type="button" class="btn btn-danger" id="btn-add-out">Add</button>
                                </div>
                            </div>
                            <div id="out-info" class="st-info">Tersedia: -</div>
                        </div>
                    </div>
                    
                    <div class="glass" style="padding:20px; display:flex; flex-direction:column;">
                        <label class="f-label">Keranjang Transaksi</label>
                        <div class="table-wrap" style="flex:1; max-height:350px; overflow-y:auto;">
                            <table>
                                <thead><tr><th>Item</th><th>Qty</th><th>Unit</th><th></th></tr></thead>
                                <tbody id="out-cart"></tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-danger" id="btn-save-out" style="width:100%; margin-top:15px; justify-content:center; font-size:1rem;">Simpan Keluar</button>
                    </div>
                </div>
            </section>

            <!-- STOCK OPNAME -->
            <section id="v-stockopname" class="hidden">
                <h3 class="section-title">Stock Opname</h3>
                <div class="glass" style="padding:20px;">
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:100px;">Code</th>
                                    <th>Item Name</th>
                                    <th>System Stock</th>
                                    <th style="width:140px;">Count Unit</th>
                                    <th style="width:100px;">Fisik (Qty)</th>
                                    <th style="width:100px;">Selisih</th>
                                    <th style="width:60px;"></th>
                                </tr>
                            </thead>
                            <tbody id="op-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- HISTORY -->
            <section id="v-history" class="hidden">
                <h3 class="section-title">Riwayat Transaksi</h3>
                <div class="glass" style="padding:15px; margin-bottom:15px; display:flex; gap:10px;">
                    <input type="text" id="h-search" placeholder="Cari Item..." style="width:250px;">
                    <select id="h-type" style="width:150px;"><option value="all">Semua</option><option value="IN">Masuk</option><option value="OUT">Keluar</option><option value="ADJ">Opname</option></select>
                </div>
                <div class="glass" style="padding:0; overflow:hidden;">
                    <div class="table-wrap">
                        <table>
                            <thead><tr><th style="width:120px;">Date</th><th style="width:60px;">Type</th><th>Ref</th><th>Item</th><th style="width:80px; text-align:right;">Qty</th><th style="width:80px;">Unit</th><th>User</th></tr></thead>
                            <tbody id="h-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- SUPPLIERS -->
            <section id="v-suppliers" class="hidden">
                <h3 class="section-title">Master Supplier</h3>
                <div class="glass" style="padding:20px;">
                    <form id="f-supp" style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:15px; margin-bottom:20px; align-items:end;">
                        <div>
                            <label class="f-label">Nama Supplier</label>
                            <input type="text" id="s-name" required>
                        </div>
                        <div>
                            <label class="f-label">Kontak</label>
                            <input type="text" id="s-contact">
                        </div>
                        <div>
                            <label class="f-label">Alamat</label>
                            <input type="text" id="s-addr" placeholder="Jalan, Kota...">
                        </div>
                        <button type="submit" class="btn">Add</button>
                        <div style="grid-column: 1 / -1;">
                            <label class="f-label">Keterangan</label>
                            <textarea id="s-notes" rows="1" placeholder="Catatan tambahan..."></textarea>
                        </div>
                    </form>
                    <div class="table-wrap">
                        <table>
                            <thead><tr><th>Nama</th><th>Kontak</th><th>Alamat</th><th>Keterangan</th><th style="width:60px;"></th></tr></thead>
                            <tbody id="s-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ADMIN -->
            <section id="v-admin" class="hidden">
                <h3 class="section-title">Master Data</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    
                    <!-- ITEM MASTER -->
                    <div class="glass" style="padding:20px;">
                        <h4 style="margin-bottom:15px; color:var(--primary);">Data Barang</h4>
                        <form id="f-item" style="display:grid; gap:15px; margin-bottom:20px; background:rgba(255,255,255,0.03); padding:15px; border-radius:12px;">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                                <input type="text" id="i-code" placeholder="Kode (Unique)" required>
                                <input type="text" id="i-name" placeholder="Nama Barang" required>
                            </div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap:15px;">
                                <input type="text" id="i-base" placeholder="Satuan Dasar (PCS)" required>
                                <input type="number" id="i-min" placeholder="Min Stock" required>
                                <button type="submit" class="btn">Simpan</button>
                            </div>
                        </form>
                        <div class="table-wrap" style="max-height:250px; overflow-y:auto;">
                            <table>
                                <thead><tr><th style="width:80px;">Code</th><th>Name</th><th style="width:100px;">Stock</th><th style="width:50px;"></th></tr></thead>
                                <tbody id="i-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- UNIT MANAGEMENT -->
                    <div class="glass" style="padding:20px;">
                        <h4 style="margin-bottom:15px; color:var(--warning);">Manage Units & Conversions</h4>
                        <div style="margin-bottom:20px;">
                            <label class="f-label">Pilih Barang</label>
                            <select id="adm-sel-item" style="width:100%;">
                                <option value="">-- Pilih Barang --</option>
                            </select>
                        </div>

                        <div id="adm-unit-panel" class="hidden" style="border-top:1px solid var(--border); padding-top:20px;">
                            <div style="margin-bottom:15px;">
                                <label class="f-label">Daftar Satuan Aktif:</label>
                                <div id="adm-unit-list" style="min-height:50px; background:rgba(0,0,0,0.2); padding:10px; border-radius:12px;"></div>
                            </div>

                            <form id="f-add-unit" style="display:flex; gap:10px; align-items:flex-end;">
                                <div style="flex:1;">
                                    <label class="f-label">Nama Satuan</label>
                                    <input type="text" id="adm-u-name" placeholder="Contoh: Box">
                                </div>
                                <div style="width:80px;">
                                    <label class="f-label">Faktor</label>
                                    <input type="number" id="adm-u-factor" placeholder="12" min="1">
                                </div>
                                <button type="submit" class="btn btn-sm">Add</button>
                            </form>
                        </div>
                    </div>

                    <!-- USERS -->
                    <div class="glass" style="padding:20px;">
                        <h4 style="margin-bottom:15px; color:var(--primary);">Data User</h4>
                        <form id="f-user" style="display:flex; gap:10px; margin-bottom:15px;">
                            <input type="text" id="u-name" placeholder="User" required>
                            <input type="password" id="u-pass" placeholder="Pass" required>
                            <select id="u-role"><option value="user">User</option><option value="admin">Admin</option></select>
                            <button type="submit" class="btn btn-sm">+</button>
                        </form>
                        <div class="table-wrap">
                            <table><thead><tr><th>User</th><th>Role</th><th style="width:50px;"></th></tr></thead><tbody id="u-body"></tbody></table>
                        </div>
                    </div>

                </div>
            </section>

        </main>
    </div>

    <script>
        const App = {
            data: { users: [], items: [], suppliers: [], tx: [] },
            user: null,
            cartIn: [],
            cartOut: [],
            tmpItem: null,

            init() {
                this.load();
                this.bg();
                this.events();
                if(this.user) this.showApp();
                this.dates();
            },

            load() {
                const s = localStorage.getItem('w2w_ultimate');
                if(s) {
                    try {
                        this.data = JSON.parse(s);
                        // Validation check to prevent corruption errors
                        if(!Array.isArray(this.data.items)) throw new Error("Data Corrupted");
                    } catch(e) {
                        console.error("Data Load Error, Resetting", e);
                        this.resetData();
                    }
                } else {
                    this.resetData();
                }
            },
            
            resetData() {
                this.data.users = [{u:'admin',p:'admin',r:'admin'}];
                this.data.suppliers = [{id:1, n:'PT Steel', c:'081', a:'Jl. A', notes:'Utama'}];
                this.data.items = [
                    {c:'S001', n:'Besi Beton', b:'Batang', s:100, m:20, units:[{n:'Batang', f:1}, {n:'Ikatan', f:10}]},
                    {c:'S002', n:'Semen', b:'Sak', s:50, m:10, units:[{n:'Sak', f:1}]},
                    {c:'E001', n:'Kabel', b:'Meter', s:200, m:50, units:[{n:'Meter', f:1}, {n:'Roll', f:50}]}
                ];
                this.save();
            },

            save() { 
                localStorage.setItem('w2w_ultimate', JSON.stringify(this.data)); 
            },
            dates() {
                const d = new Date().toISOString().split('T')[0];
                document.getElementById('in-date').value = d;
                document.getElementById('out-date').value = d;
            },

            toast(m, t='success') {
                const b = document.getElementById('toast-box');
                const e = document.createElement('div');
                e.className = 'toast'; e.style.borderLeftColor = t==='error'?'var(--danger)':'var(--success)';
                e.innerText = m; b.appendChild(e);
                setTimeout(()=> e.remove(), 3000);
            },
            bg() {
                const s = document.getElementById('bg-scene');
                for(let i=0;i<20;i++) {
                    const c = document.createElement('div'); c.className='cube';
                    const sz = Math.random()*50+30; c.style.width=c.style.height=sz+'px';
                    c.style.left=Math.random()*100+'%'; c.style.animationDuration=(Math.random()*20+25)+'s';
                    s.appendChild(c);
                }
            },

            /* --- LOGIC --- */
            getEffStock(item, type) {
                const activeCart = type === 'in' ? this.cartIn : this.cartOut;
                const inCartBase = activeCart.filter(x=>x.code === item.c).reduce((a,b)=>a+b.bq, 0);
                return item.s - inCartBase;
            },

            clearCarts() {
                this.cartIn = [];
                this.cartOut = [];
                this.renderCart('in');
                this.renderCart('out');
            },

            events() {
                // Login
                document.getElementById('login-form').onsubmit = (e) => {
                    e.preventDefault();
                    const u = document.getElementById('l-user').value;
                    const p = document.getElementById('l-pass').value;
                    const x = this.data.users.find(x=>x.u===u && x.p===p);
                    if(x) { this.user = x; document.getElementById('login-screen').classList.add('hidden'); this.showApp(); this.toast('Login Success'); }
                    else this.toast('Login Failed', 'error');
                };

                // Tabs
                document.querySelectorAll('.tab').forEach(b => b.onclick = () => {
                    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
                    document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
                    b.classList.add('active');
                    document.getElementById('v-'+b.dataset.t).classList.remove('hidden');
                    
                    // CRITICAL FIX: CLEAR CARTS ON TAB SWITCH
                    this.tmpItem = null;
                    this.clearCarts();

                    if(b.dataset.t === 'stockopname') this.renderOpname();
                    if(b.dataset.t === 'history') this.renderHist();
                });

                /* --- AUTOCOMPLETE & KEYBOARD FLOW --- */
                const setupFlow = (type) => {
                    const searchId = type+'-search';
                    const listId = type+'-list';
                    const unitId = type+'-unit';
                    const infoId = type+'-info';
                    const qtyId = type+'-qty';
                    const btnId = 'btn-add-'+type;
                    
                    const inp = document.getElementById(searchId);
                    const list = document.getElementById(listId);
                    const qty = document.getElementById(qtyId);

                    inp.addEventListener('input', () => {
                        list.style.display = 'none';
                        if(!inp.value) return;
                        list.innerHTML = '';
                        this.data.items.filter(i => i.n.toUpperCase().includes(inp.value.toUpperCase())).forEach(i => {
                            const d = document.createElement('div');
                            d.innerHTML = `<strong>${i.n}</strong> <span style="font-size:0.8em; opacity:0.6; margin-left:auto;">${i.c}</span>`;
                            d.onclick = () => { 
                                inp.value = i.n; 
                                this.tmpItem = i;
                                this.populateUnits(i, unitId); 
                                this.updateStockInfo(infoId, i, type);
                                list.style.display = 'none'; 
                                qty.focus();
                            };
                            list.appendChild(d);
                        });
                        list.style.display = 'block';
                    });

                    inp.addEventListener('keydown', (e) => {
                        if(e.key === 'Enter') {
                            e.preventDefault();
                            if(list.style.display === 'block' && list.children.length > 0) {
                                list.children[0].click();
                            } else if (this.tmpItem) {
                                qty.focus();
                            }
                        }
                    });

                    qty.addEventListener('keydown', (e) => {
                        if(e.key === 'Enter') {
                            e.preventDefault();
                            document.getElementById(btnId).click();
                        }
                    });

                    document.addEventListener('click', (e) => { if(e.target !== inp) list.style.display = 'none'; });
                };

                setupFlow('in');
                setupFlow('out');

                // Incoming Actions
                document.getElementById('in-qty').addEventListener('input', () => this.validateInput('in'));
                document.getElementById('btn-add-in').onclick = () => this.addToCart('in');
                document.getElementById('btn-save-in').onclick = () => this.saveTx('IN');

                // Outgoing Actions
                document.getElementById('out-qty').addEventListener('input', () => this.validateInput('out'));
                document.getElementById('btn-add-out').onclick = () => this.addToCart('out');
                document.getElementById('btn-save-out').onclick = () => this.saveTx('OUT');

                /* --- ADMIN UNIT MANAGEMENT --- */
                document.getElementById('adm-sel-item').onchange = (e) => {
                    const v = e.target.value;
                    const p = document.getElementById('adm-unit-panel');
                    if(!v) { p.classList.add('hidden'); return; }
                    p.classList.remove('hidden');
                    const item = this.data.items.find(i=>i.c===v);
                    this.renderUnitList(item);
                };

                document.getElementById('f-add-unit').onsubmit = (e) => {
                    e.preventDefault();
                    const c = document.getElementById('adm-sel-item').value;
                    const n = document.getElementById('adm-u-name').value;
                    const f = parseFloat(document.getElementById('adm-u-factor').value);
                    
                    if(!c || !n || f<=0) return;
                    const item = this.data.items.find(i=>i.c===c);
                    if(item.units.find(u=>u.n===n)) return this.toast('Satuan sudah ada', 'error');
                    
                    item.units.push({n:n, f:f});
                    this.save();
                    this.renderUnitList(item);
                    document.getElementById('adm-u-name').value=''; document.getElementById('adm-u-factor').value='';
                    this.toast('Satuan Ditambah');
                };

                /* --- FORMS --- */
                document.getElementById('f-supp').onsubmit = (e) => {
                    e.preventDefault();
                    this.data.suppliers.push({
                        id:Date.now(), n:document.getElementById('s-name').value,
                        c:document.getElementById('s-contact').value, a:document.getElementById('s-addr').value,
                        notes:document.getElementById('s-notes').value
                    });
                    this.save(); this.renderSupp(); document.getElementById('f-supp').reset();
                };

                document.getElementById('f-item').onsubmit = (e) => {
                    e.preventDefault();
                    const c = document.getElementById('i-code').value;
                    if(this.data.items.find(x=>x.c===c)) return this.toast('Kode ada', 'error');
                    const b = document.getElementById('i-base').value;
                    this.data.items.push({
                        c:c, n:document.getElementById('i-name').value, b:b,
                        s:0, m:parseInt(document.getElementById('i-min').value),
                        units: [{n:b, f:1}]
                    });
                    this.save(); this.renderItems(); this.renderAdminSelect(); document.getElementById('f-item').reset();
                };

                document.getElementById('f-user').onsubmit = (e) => {
                    e.preventDefault();
                    this.data.users.push({
                        u:document.getElementById('u-name').value, p:document.getElementById('u-pass').value, r:document.getElementById('u-role').value
                    });
                    this.save(); this.renderUsers(); document.getElementById('f-user').reset();
                };

                /* --- HISTORY --- */
                document.getElementById('h-search').addEventListener('input', () => this.renderHist());
                document.getElementById('h-type').addEventListener('change', () => this.renderHist());
            },

            /* --- CORE FUNCTIONS --- */
            populateUnits(item, selectId) {
                const s = document.getElementById(selectId);
                s.innerHTML = item.units.map(u => `<option value="${u.n}" data-f="${u.f}">${u.n}</option>`).join('');
            },

            updateStockInfo(divId, item, type) {
                const d = document.getElementById(divId);
                const eff = this.getEffStock(item, type);
                if(divId === 'in-info') d.innerText = `Stok Sistem: ${item.s} ${item.b}`;
                else d.innerText = `Tersedia: ${eff} ${item.b} (Kurang keranjang)`;
                d.className = 'st-info ' + (eff < item.m ? 'bad' : 'good');
            },

            validateInput(type) {
                const item = this.tmpItem;
                if(!item) return;
                const qty = parseFloat(document.getElementById(type+'-qty').value) || 0;
                const sel = document.getElementById(type+'-unit');
                // Guard: Check if selection exists
                if(sel.selectedIndex < 0) {
                     document.getElementById(type+'-info').innerText = "Pilih Satuan!";
                     document.getElementById(type+'-info').className = 'st-info bad';
                     return false;
                }
                const factor = parseFloat(sel.options[sel.selectedIndex].dataset.f);
                const baseReq = qty * factor;
                
                const info = document.getElementById(type+'-info');
                if(type === 'out') {
                    const avail = this.getEffStock(item, 'out');
                    if(baseReq > avail) {
                        info.innerText = `Error: Kurang ${baseReq - avail} ${item.b}`;
                        info.className = 'st-info bad';
                        return false;
                    } else {
                        info.innerText = `Ok: Mengurangi ${baseReq} ${item.b}`;
                        info.className = 'st-info good';
                    }
                }
                return true;
            },

            addToCart(type) {
                if(!this.tmpItem) return;
                if(type==='out' && !this.validateInput('out')) return;
                
                const item = this.tmpItem;
                const qty = parseFloat(document.getElementById(type+'-qty').value) || 0;
                if(qty<=0) return this.toast('Qty salah', 'error');

                const sel = document.getElementById(type+'-unit');
                const unitName = sel.value;
                const factor = parseFloat(sel.options[sel.selectedIndex].dataset.f);
                
                // NaN Guard
                if(isNaN(factor) || isNaN(qty)) return this.toast('Data Satuan Salah', 'error');
                
                const baseQty = qty * factor;

                const cartData = {code:item.c, n:item.n, q:qty, u:unitName, f:factor, bq:baseQty};
                if(type === 'in') this.cartIn.push(cartData);
                else this.cartOut.push(cartData);

                this.renderCart(type);
                
                // Reset and Focus Loop
                document.getElementById(type+'-search').value=''; 
                document.getElementById(type+'-search').focus(); 
                document.getElementById(type+'-unit').innerHTML=''; 
                document.getElementById(type+'-qty').value=1; 
                document.getElementById(type+'-info').innerText='-';
                document.getElementById(type+'-info').className = 'st-info';
                this.tmpItem = null;
            },

            renderCart(type) {
                const activeCart = type === 'in' ? this.cartIn : this.cartOut;
                const b = document.getElementById(type+'-cart');
                b.innerHTML = activeCart.map((x,i) => 
                    `<tr><td>${x.n}</td><td style="text-align:right;">${x.q}</td><td style="text-align:center;">${x.u}</td><td style="text-align:center;"><button onclick="App.rmCart('${type}',${i})" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:1.2rem;">&times;</button></td></tr>`
                ).join('');
            },
            rmCart(t,i) { 
                if(t==='in') this.cartIn.splice(i,1);
                else this.cartOut.splice(i,1);
                this.renderCart(t); 
            },

            saveTx(type) {
                const activeCart = type === 'IN' ? this.cartIn : this.cartOut;
                if(activeCart.length===0) return this.toast('Keranjang kosong', 'warning');
                
                const ref = type==='IN' ? document.getElementById('in-ref').value : document.getElementById('out-dest').value;
                const d = document.getElementById(type+'-date').value;
                
                let errorFound = false;

                // LOOP AND UPDATE STOCK
                activeCart.forEach(c => {
                    const it = this.data.items.find(x=>x.c===c.code);
                    
                    if(!it) {
                        console.error("Master item missing for transaction", c);
                        return; 
                    }

                    // NaN Guard 2
                    if(isNaN(c.bq)) {
                        this.toast(`Error pada item ${c.n}: Nilai stok tidak valid`, 'error');
                        errorFound = true;
                        return;
                    }

                    if(type==='IN') {
                        // Ensure stock is number
                        it.s = (parseFloat(it.s) || 0) + c.bq;
                    } else {
                        it.s = (parseFloat(it.s) || 0) - c.bq;
                    }

                    // Log Transaction
                    this.data.tx.unshift({
                        id:Date.now()+Math.random(), d:d, t:type, r:ref||'N/A', i:c.n, q:c.q, u:c.u, user:this.user.u
                    });
                });

                if(errorFound) return;

                // FORCE SAVE
                this.save(); 
                
                // CLEAR SPECIFIC CART
                if(type === 'IN') this.cartIn = [];
                else this.cartOut = [];
                
                this.renderCart(type); 
                this.renderDash(); 
                this.renderItems(); // Force update stock list
                this.toast('Transaksi Berhasil Disimpan');
                
                document.getElementById('in-ref').value=''; 
                document.getElementById('out-dest').value='';
            },

            renderUnitList(item) {
                const d = document.getElementById('adm-unit-list');
                d.innerHTML = item.units.map((u, idx) => 
                    `<div class="unit-tag">${u.n} (x${u.f}) ${u.f!==1 ? `<span onclick="App.delUnit('${item.c}',${idx})" style="margin-left:8px; font-weight:bold; cursor:pointer;">&times;</span>` : ''}</div>`
                ).join('');
            },
            delUnit(code, idx) {
                if(!confirm('Hapus satuan ini?')) return;
                const it = this.data.items.find(i=>i.c===code);
                if(it.units[idx].f === 1) return this.toast('Tidak bisa hapus satuan dasar', 'error');
                it.units.splice(idx, 1);
                this.save(); this.renderUnitList(it);
            },

            /* --- RENDERS --- */
            showApp() {
                document.getElementById('app-main').classList.remove('hidden');
                document.getElementById('u-display').innerText = this.user.u;
                this.renderAll();
            },
            renderAll() {
                this.renderDash();
                this.renderSupp();
                this.renderItems();
                this.renderAdminSelect();
                this.renderUsers();
            },
            renderDash() {
                document.getElementById('d-items').innerText = this.data.items.length;
                document.getElementById('d-stock').innerText = this.data.items.reduce((a,b)=>a+(parseFloat(b.s)||0), 0);
                document.getElementById('d-low').innerText = this.data.items.filter(i=>i.s<=i.m).length;
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('d-tx').innerText = this.data.tx.filter(t=>t.d===today).length;
            },
            renderSupp() {
                const b = document.getElementById('s-body');
                const sl = document.getElementById('in-supp');
                b.innerHTML = this.data.suppliers.map((s,i) => 
                    `<tr><td><strong>${s.n}</strong></td><td>${s.c}</td><td>${s.a||'-'}</td><td><small style="color:var(--text-muted)">${s.notes||'-'}</small></td><td style="text-align:center;"><button class="btn-ghost btn-sm" onclick="App.delSupp(${i})">&times;</button></td></tr>`
                ).join('');
                sl.innerHTML = '<option value="">Pilih Supplier</option>' + this.data.suppliers.map(s => `<option value="${s.n}">${s.n}</option>`).join('');
            },
            delSupp(i) { if(confirm('Hapus?')) { this.data.suppliers.splice(i,1); this.save(); this.renderSupp(); } },
            
            renderItems() {
                const b = document.getElementById('i-body');
                b.innerHTML = this.data.items.map(i => 
                    `<tr><td>${i.c}</td><td>${i.n}</td><td><strong>${i.s}</strong> ${i.b}</td><td style="text-align:center;"><button class="btn-ghost btn-sm" onclick="App.delItem('${i.c}')">&times;</button></td></tr>`
                ).join('');
            },
            delItem(c) { if(confirm('Hapus?')) { this.data.items = this.data.items.filter(i=>i.c!==c); this.save(); this.renderItems(); } },
            
            renderAdminSelect() {
                const s = document.getElementById('adm-sel-item');
                const curr = s.value;
                s.innerHTML = '<option value="">-- Pilih Barang --</option>' + this.data.items.map(i => `<option value="${i.c}">${i.n}</option>`).join('');
                if(curr) s.value = curr;
            },

            renderUsers() {
                const b = document.getElementById('u-body');
                b.innerHTML = this.data.users.map((u,i) => 
                    `<tr><td>${u.u}</td><td>${u.r}</td><td style="text-align:center;">${u.u!=='admin'?`<button class="btn-ghost btn-sm" onclick="App.delUser(${i})">&times;</button>`:''}</td></tr>`
                ).join('');
            },
            delUser(i) { if(confirm('Hapus?')) { this.data.users.splice(i,1); this.save(); this.renderUsers(); } },

            renderHist() {
                const s = document.getElementById('h-search').value.toLowerCase();
                const t = document.getElementById('h-type').value;
                const b = document.getElementById('h-body');
                b.innerHTML = this.data.tx
                    .filter(x => (t==='all'||x.t===t) && x.i.toLowerCase().includes(s))
                    .slice(0,50)
                    .map(x => `<tr><td>${x.d}</td><td><span style="font-weight:bold; color:${x.t==='IN'?'var(--success)':(x.t==='OUT'?'var(--danger)':'var(--warning)')}">${x.t}</span></td><td>${x.r}</td><td>${x.i}</td><td style="text-align:right;">${x.q}</td><td style="text-align:center;">${x.u}</td><td>${x.user}</td></tr>`).join('');
            },

            renderOpname() {
                const b = document.getElementById('op-body');
                b.innerHTML = this.data.items.map(i => {
                    let opts = i.units.map(u => `<option value="${u.n}" data-f="${u.f}">${u.n}</option>`).join('');
                    return `
                    <tr>
                        <td>${i.c}</td>
                        <td>${i.n}</td>
                        <td style="font-weight:bold;">${i.s} ${i.b}</td>
                        <td><select class="op-unit" onchange="App.calcOpname(this)">${opts}</select></td>
                        <td><input type="number" class="op-input" data-c="${i.c}" style="width:100%; text-align:center;" oninput="App.calcOpname(this)"></td>
                        <td class="op-diff">0</td>
                        <td><button class="btn btn-sm" onclick="App.adjOpname(this)">Adj</button></td>
                    </tr>`;
                }).join('');
            },
            calcOpname(el) {
                const row = el.closest('tr');
                const code = row.querySelector('.op-input').dataset.c;
                const item = this.data.items.find(x=>x.c===code);
                const sel = row.querySelector('.op-unit');
                const factor = parseFloat(sel.options[sel.selectedIndex].dataset.f);
                const phy = parseFloat(row.querySelector('.op-input').value)||0;
                const diff = (phy * factor) - item.s;
                const d = row.querySelector('.op-diff');
                d.innerText = diff>0?`+${diff}`:diff;
                d.style.color = diff>0?'var(--success)':(diff<0?'var(--danger)':'inherit');
            },
            adjOpname(btn) {
                const row = btn.closest('tr');
                const code = row.querySelector('.op-input').dataset.c;
                const diffStr = row.querySelector('.op-diff').innerText;
                const diff = parseFloat(diffStr);
                if(diff===0) return this.toast('Tidak ada selisih', 'warning');
                
                const it = this.data.items.find(x=>x.c===code);
                it.s += diff;
                
                this.data.tx.unshift({
                    id:Date.now(), d:document.getElementById('in-date').value, t:'ADJ', r:'Opname', i:it.n, q:Math.abs(diff), u:it.b, user:this.user.u
                });
                
                this.save(); this.renderOpname(); this.renderDash(); this.toast('Stok Diadjust');
            }
        };

        App.init();
    </script>
</body>
</html>
