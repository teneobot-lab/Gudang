<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blue Steel Enterprise WMS</title>
  
  <!-- Icons & Fonts -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- CORE VARIABLES --- */
    :root {
      --bg-dark: #020617;       /* Very Dark Blue */
      --bg-accent: #0f172a;     /* Slate 900 */
      --primary: #38bdf8;       /* Sky 400 (Cyan-ish Blue) */
      --primary-glow: rgba(56, 189, 248, 0.4);
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --glass: rgba(15, 23, 42, 0.6);
      --border: rgba(56, 189, 248, 0.2);
    }

    * { box-sizing: border-box; outline: none; }
    
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      background-image: radial-gradient(circle at 50% 50%, #1e293b 0%, #020617 100%);
    }

    /* --- 3D CUBE ANIMATION --- */
    .scene {
      width: 200px;
      height: 200px;
      perspective: 600px;
      position: absolute;
      z-index: 1; /* Behind the login shield */
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .cube {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      animation: rotateCube 10s infinite linear;
    }

    .cube__face {
      position: absolute;
      width: 200px;
      height: 200px;
      border: 2px solid var(--primary);
      background: rgba(56, 189, 248, 0.05); /* Transparent */
      box-shadow: 0 0 20px var(--primary-glow);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      color: var(--primary);
    }

    .cube__face--front  { transform: rotateY(  0deg) translateZ(100px); }
    .cube__face--right  { transform: rotateY( 90deg) translateZ(100px); }
    .cube__face--back   { transform: rotateY(180deg) translateZ(100px); }
    .cube__face--left   { transform: rotateY(-90deg) translateZ(100px); }
    .cube__face--top    { transform: rotateX( 90deg) translateZ(100px); }
    .cube__face--bottom { transform: rotateX(-90deg) translateZ(100px); }

    @keyframes rotateCube {
      0% { transform: rotateX(0deg) rotateY(0deg); }
      100% { transform: rotateX(360deg) rotateY(360deg); }
    }

    /* --- LOGIN SHIELD CONTAINER --- */
    #login-wrapper {
      position: relative;
      z-index: 10; /* Above cube */
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .login-shield {
      width: 420px;
      padding: 50px 30px 30px 30px; /* Extra padding top */
      position: relative;
      /* Glassmorphism */
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.7), rgba(15, 23, 42, 0.9));
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid var(--border);
      border-top: 2px solid var(--primary);
      
      /* THE SHIELD SHAPE CLIP-PATH */
      clip-path: polygon(
        10% 0, 
        90% 0, 
        100% 15%, 
        100% 80%, 
        50% 100%, 
        0 80%, 
        0 15%
      );
      
      box-shadow: 0 0 50px rgba(0,0,0,0.5);
      transition: transform 0.3s ease;
    }

    .login-shield:hover {
      transform: scale(1.02);
      box-shadow: 0 0 60px var(--primary-glow);
    }

    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .login-logo {
      font-size: 3rem;
      color: var(--primary);
      margin-bottom: 10px;
      filter: drop-shadow(0 0 10px var(--primary));
    }

    .login-title {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin: 0;
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }

    .login-subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 5px;
    }

    /* --- FORM ELEMENTS --- */
    .input-group { margin-bottom: 20px; position: relative; }
    
    .input-group label {
      display: block;
      font-size: 0.75rem;
      color: var(--primary);
      margin-bottom: 5px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input, select {
      width: 100%;
      background: rgba(2, 6, 23, 0.6);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 12px 15px;
      border-radius: 4px;
      font-family: 'Inter', sans-serif;
      font-size: 0.95rem;
      transition: all 0.3s;
    }

    input:focus, select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 15px rgba(56, 189, 248, 0.2);
      background: rgba(2, 6, 23, 0.8);
    }

    /* --- BUTTONS --- */
    .btn {
      width: 100%;
      background: linear-gradient(90deg, #0ea5e9, #2563eb);
      color: white;
      padding: 14px;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
      clip-path: polygon(5% 0, 95% 0, 100% 50%, 95% 100%, 5% 100%, 0 50%); /* Button shape */
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.6);
      filter: brightness(1.1);
    }

    .btn:active { transform: translateY(1px); }

    /* --- MAIN APP LAYOUT (Hidden at start) --- */
    #app-layout { display: flex; height: 100%; width: 100%; position: absolute; top: 0; left: 0; background: var(--bg-dark); }
    
    aside {
      width: 260px;
      background: var(--bg-accent);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 1.5rem;
      z-index: 50;
    }

    aside .brand { margin-bottom: 2rem; color: var(--primary); font-weight: 700; font-size: 1.2rem; display:flex; align-items:center; gap:10px; }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      color: var(--text-muted);
      text-decoration: none;
      border-radius: 6px;
      margin-bottom: 4px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .nav-link:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
    .nav-link.active { background: var(--primary); color: white; box-shadow: 0 0 15px var(--primary-glow); }
    .nav-link i { font-size: 1.2rem; }

    .user-profile {
      margin-top: auto;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    main {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
      background: radial-gradient(circle at top right, #1e293b 0%, #020617 100%);
    }

    /* --- PAGES & UTILS --- */
    .hidden { display: none !important; }
    .page { display: none; animation: fadeIn 0.4s ease-out; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .card {
      background: var(--bg-accent);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    /* Tables */
    .table-container { width: 100%; overflow-x: auto; border: 1px solid var(--border); border-radius: 6px; margin-top: 1rem; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th { background: rgba(56, 189, 248, 0.1); text-align: left; padding: 12px 16px; font-weight: 600; color: var(--primary); border-bottom: 1px solid var(--border); }
    td { padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--text-muted); }
    tr:hover td { background: rgba(255,255,255,0.02); color: #fff; }

    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .badge-in { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .badge-out { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .badge-low { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }

    /* Buttons Styles for App */
    .btn-sm { padding: 5px 10px; font-size: 0.8rem; width: auto; }
    .btn-danger { background: linear-gradient(90deg, #ef4444, #b91c1c); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); box-shadow: none; }
    .btn-outline:hover { border-color: var(--text-main); color: var(--text-main); }

    /* Toast */
    #toast { position: fixed; bottom: 24px; right: 24px; background: var(--bg-accent); border-left: 4px solid var(--primary); padding: 16px 24px; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: translateY(100px); transition: transform 0.3s; z-index: 1000; }
    #toast.show { transform: translateY(0); }
    #toast.error { border-left-color: var(--danger); }
    
    /* Mobile */
    @media (max-width: 768px) {
      .scene { width: 150px; height: 150px; }
      .cube__face { width: 150px; height: 150px; }
      .cube__face--front  { transform: rotateY(  0deg) translateZ(75px); }
      .cube__face--right  { transform: rotateY( 90deg) translateZ(75px); }
      .cube__face--back   { transform: rotateY(180deg) translateZ(75px); }
      .cube__face--left   { transform: rotateY(-90deg) translateZ(75px); }
      .cube__face--top    { transform: rotateX( 90deg) translateZ(75px); }
      .cube__face--bottom { transform: rotateX(-90deg) translateZ(75px); }
      
      .login-shield { width: 90%; padding: 40px 20px; }
      #app-layout { flex-direction: column; }
      aside { width: 100%; height: auto; padding: 1rem; border-right: none; border-bottom: 1px solid var(--border); overflow-x: auto; flex-direction: row; align-items: center; gap: 1rem; }
      aside .brand { display: none; }
      .user-profile { display: none; }
    }
  </style>
</head>
<body>

  <!-- LOGIN PAGE WITH CUBE & SHIELD -->
  <div id="login-screen">
    <!-- 3D Animated Cube Background -->
    <div class="scene">
      <div class="cube">
        <div class="cube__face cube__face--front"><i class="ph ph-cube"></i></div>
        <div class="cube__face cube__face--back"></div>
        <div class="cube__face cube__face--right"></div>
        <div class="cube__face cube__face--left"></div>
        <div class="cube__face cube__face--top"></div>
        <div class="cube__face cube__face--bottom"></div>
      </div>
    </div>

    <!-- Login Shield Container -->
    <div id="login-wrapper">
      <div class="login-shield">
        
        <!-- Setup View -->
        <div id="view-setup" class="hidden">
          <div class="login-header">
            <div class="login-logo"><i class="ph ph-shield-check"></i></div>
            <h1 class="login-title">SYSTEM INIT</h1>
            <p class="login-subtitle">Initial Configuration Required</p>
          </div>
          <div class="input-group">
            <label>Admin Username</label>
            <input type="text" id="setup-user" value="admin" autocomplete="off">
          </div>
          <div class="input-group">
            <label>Admin Password</label>
            <input type="password" id="setup-pass" value="admin123">
          </div>
          <button class="btn" onclick="doSetup()">INITIALIZE SYSTEM</button>
        </div>

        <!-- Login View -->
        <div id="view-login">
          <div class="login-header">
            <div class="login-logo"><i class="ph ph-shield-star"></i></div>
            <h1 class="login-title">ACCESS GRANTED</h1>
            <p class="login-subtitle">Blue Steel Warehouse Management</p>
          </div>
          
          <div class="input-group">
            <label>Username ID</label>
            <input type="text" id="login-user" placeholder="Enter ID" autocomplete="off">
          </div>
          <div class="input-group">
            <label>Passcode</label>
            <input type="password" id="login-pass" placeholder="••••••••" onkeypress="if(event.key==='Enter') doLogin()">
          </div>
          
          <button class="btn" onclick="doLogin()">LOGIN SYSTEM</button>
          
          <div style="text-align: center; margin-top: 20px;">
            <p class="login-subtitle" style="font-size: 0.7rem;">SECURE CONNECTION // V2.0</p>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- MAIN APP LAYOUT (Hidden Initially) -->
  <div id="app-layout" class="hidden">
    <aside>
      <div class="brand">
        <i class="ph ph-cube-transparent" style="font-size:24px;"></i>
        <span>BLUE STEEL</span>
      </div>
      <nav>
        <a href="#" class="nav-link active" onclick="switchTab('masuk', this)"><i class="ph ph-arrow-down-left"></i> Barang Masuk</a>
        <a href="#" class="nav-link" onclick="switchTab('keluar', this)"><i class="ph ph-arrow-up-right"></i> Barang Keluar</a>
        <a href="#" class="nav-link" onclick="switchTab('riwayat', this)"><i class="ph ph-clock-counter-clockwise"></i> Riwayat</a>
        <a href="#" class="nav-link" id="nav-master" onclick="switchTab('master', this)"><i class="ph ph-database"></i> Data Master</a>
        <a href="#" class="nav-link" id="nav-admin" onclick="switchTab('admin', this)"><i class="ph ph-shield-check"></i> Admin</a>
      </nav>
      <div class="user-profile">
        <div>
          <div id="user-name" style="font-weight:600; font-size:0.9rem;">Admin User</div>
          <div id="user-role" style="font-size:0.8rem; color:var(--text-muted);">ADMINISTRATOR</div>
        </div>
        <button class="btn-outline btn-sm" style="padding:4px 8px; border:none;" onclick="logout()"><i class="ph ph-sign-out" style="font-size:1.2rem;"></i></button>
      </div>
    </aside>

    <main>
      
      <!-- TAB MASUK -->
      <section id="tab-masuk" class="page active">
        <div class="flex justify-between items-center mb-4">
          <h2 style="margin:0;">Input Barang Masuk</h2>
        </div>

        <div class="card form-grid">
          <div>
            <label>Tanggal</label>
            <input type="date" id="in-date">
          </div>
          <div>
            <label>No. Surat Jalan</label>
            <input type="text" id="in-ref" placeholder="SJ-xxx">
          </div>
          <div>
            <label>Supplier</label>
            <input type="text" id="in-supplier">
          </div>
        </div>

        <div class="card" style="border-color: var(--primary); box-shadow: 0 0 10px rgba(56,189,248,0.1);">
          <h3 style="margin-top:0; font-size:1rem; color:var(--primary);">Fast Entry Item</h3>
          <div class="form-grid" style="margin-bottom:0;">
            <div style="grid-column: span 2;">
              <label>Nama Barang (Auto)</label>
              <input type="text" id="in-name" placeholder="Ketik nama barang..." oninput="autocomplete(this)">
            </div>
            <div>
              <label>Qty</label>
              <input type="number" id="in-qty" placeholder="0">
            </div>
            <div>
              <label>Satuan</label>
              <select id="in-unit"></select>
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn btn-sm" onclick="addItem('IN')"><i class="ph ph-plus"></i></button>
            </div>
          </div>
          <div id="in-conversion-info" class="text-muted text-sm" style="margin-top:10px;"></div>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Kode</th>
                <th>Nama Barang</th>
                <th>Qty</th>
                <th>Satuan</th>
                <th>Total (Base)</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="list-in"></tbody>
          </table>
        </div>
        <div class="mt-4 text-right">
          <button class="btn" onclick="submitTransaction('IN')">Simpan Transaksi</button>
        </div>
      </section>

      <!-- TAB KELUAR -->
      <section id="tab-keluar" class="page">
        <h2>Input Barang Keluar</h2>
        
        <div class="card form-grid">
           <div style="grid-column: span 3;">
             <label>Keterangan Global</label>
             <input type="text" id="out-notes" placeholder="Keterangan pengiriman...">
           </div>
        </div>

        <div class="card" style="border-color: var(--danger); box-shadow: 0 0 10px rgba(239,68,68,0.1);">
          <h3 style="margin-top:0; font-size:1rem; color:var(--danger);">Fast Entry Item</h3>
          <div class="form-grid" style="margin-bottom:0;">
            <div style="grid-column: span 2;">
              <label>Nama Barang</label>
              <input type="text" id="out-name" placeholder="Ketik nama..." oninput="autocomplete(this)">
            </div>
            <div>
              <label>Stok</label>
              <input type="text" id="out-stock-display" readonly style="color:var(--text-muted);">
            </div>
            <div>
              <label>Qty</label>
              <input type="number" id="out-qty" placeholder="0">
            </div>
            <div>
              <label>Satuan</label>
              <select id="out-unit"></select>
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn btn-sm btn-danger" onclick="addItem('OUT')"><i class="ph ph-minus"></i></button>
            </div>
          </div>
           <div id="out-conversion-info" class="text-muted text-sm" style="margin-top:10px;"></div>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Kode</th>
                <th>Nama Barang</th>
                <th>Qty</th>
                <th>Satuan</th>
                <th>Total (Base)</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="list-out"></tbody>
          </table>
        </div>
        <div class="mt-4 text-right">
          <button class="btn btn-danger" onclick="submitTransaction('OUT')">Proses Keluar</button>
        </div>
      </section>

      <!-- TAB RIWAYAT -->
      <section id="tab-riwayat" class="page">
        <div class="flex justify-between items-center mb-4">
          <h2>Riwayat Transaksi</h2>
          <button class="btn btn-outline" onclick="exportExcel()"><i class="ph ph-file-xls"></i> Export</button>
        </div>
        
        <div class="card form-grid">
           <div><label>Dari Tanggal</label><input type="date" id="hist-start"></div>
           <div><label>Sampai Tanggal</label><input type="date" id="hist-end"></div>
           <div><label>Tipe</label>
             <select id="hist-type">
               <option value="">Semua</option>
               <option value="IN">Masuk</option>
               <option value="OUT">Keluar</option>
             </select>
           </div>
           <div style="display:flex; align-items:flex-end;"><button class="btn btn-sm" onclick="loadHistory()"><i class="ph ph-funnel"></i> Filter</button></div>
        </div>

        <div class="table-container">
          <table id="tbl-history">
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>Tipe</th>
                <th>Ref</th>
                <th>Barang</th>
                <th>Qty</th>
                <th>Stok Akhir</th>
                <th>User</th>
              </tr>
            </thead>
            <tbody id="list-history"></tbody>
          </table>
        </div>
      </section>

      <!-- TAB DATA MASTER -->
      <section id="tab-master" class="page">
        <div class="flex justify-between items-center mb-4">
          <h2>Master Data Barang</h2>
        </div>

        <div class="card" style="margin-bottom:20px;">
          <h3 style="margin-top:0; font-size:1rem; border-bottom:1px solid var(--border); padding-bottom:10px;">Form Barang</h3>
          <input type="hidden" id="m-row">
          <div class="form-grid">
            <div><label>Kode Barang</label><input type="text" id="m-code"></div>
            <div><label>Nama Barang</label><input type="text" id="m-name"></div>
            <div><label>Satuan Dasar</label><input type="text" id="m-base" placeholder="Pcs"></div>
            <div><label>Satuan Lain</label><input type="text" id="m-alt" placeholder="Box"></div>
            <div><label>Faktor Konversi</label><input type="number" id="m-factor" placeholder="1 Box = ?"></div>
            <div><label>Min Stok</label><input type="number" id="m-min"></div>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-sm" onclick="saveMaster()"><i class="ph ph-floppy-disk"></i> Simpan Data</button>
            <button class="btn btn-sm btn-outline" onclick="resetMasterForm()">Reset</button>
          </div>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Kode</th>
                <th>Nama</th>
                <th>Base</th>
                <th>Alt</th>
                <th>Faktor</th>
                <th>Stok</th>
                <th>Min</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="list-master"></tbody>
          </table>
        </div>
      </section>

      <!-- TAB ADMIN -->
      <section id="tab-admin" class="page">
        <h2>Admin & User Management</h2>
        
        <div class="card form-grid">
           <div><label>Username</label><input type="text" id="new-u-name"></div>
           <div><label>Password</label><input type="password" id="new-u-pass"></div>
           <div><label>Role</label>
             <select id="new-u-role">
               <option value="staff">Staff Gudang</option>
               <option value="admin">Administrator</option>
             </select>
           </div>
           <div style="display:flex; align-items:flex-end;"><button class="btn btn-sm" onclick="createUser()">Tambah User</button></div>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Username</th>
                <th>Role</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="list-users"></tbody>
          </table>
        </div>
      </section>

    </main>
  </div>

  <div id="toast">Notification</div>

  <script>
    /* --- GLOBAL STATE --- */
    let currentUser = null;
    let masterData = [];
    let tempItemsIN = [];
    let tempItemsOUT = [];
    let selectedItem = null;

    /* --- INIT & LOGIN --- */
    window.onload = function() {
      document.getElementById('in-date').valueAsDate = new Date();
      
      google.script.run.withSuccessHandler(res => {
        if(res.initialized) {
          document.getElementById('view-setup').classList.add('hidden');
          document.getElementById('view-login').classList.remove('hidden');
        } else {
          document.getElementById('view-setup').classList.remove('hidden');
          document.getElementById('view-login').classList.add('hidden');
        }
      }).checkSystemStatus();
    };

    function doSetup() {
      const u = document.getElementById('setup-user').value;
      const p = document.getElementById('setup-pass').value;
      if(!u || !p) return showToast('Data wajib diisi', 'error');
      
      google.script.run.withSuccessHandler(() => {
        location.reload();
      }).setupSystem(u, p);
    }

    function doLogin() {
      const u = document.getElementById('login-user').value;
      const p = document.getElementById('login-pass').value;
      
      google.script.run.withSuccessHandler(res => {
        if(res.status === 'success') {
          currentUser = res.user;
          // Animation transition
          const screen = document.getElementById('login-screen');
          screen.style.transition = "opacity 0.5s";
          screen.style.opacity = "0";
          
          setTimeout(() => {
            screen.classList.add('hidden');
            document.getElementById('app-layout').classList.remove('hidden');
            document.getElementById('user-name').innerText = currentUser.name;
            document.getElementById('user-role').innerText = currentUser.role.toUpperCase();
            applyRBAC();
            loadMasterData();
            loadHistory();
            loadUsers();
          }, 500);
        } else {
          showToast(res.message, 'error');
        }
      }).login(u, p);
    }

    function logout() {
      location.reload();
    }

    /* --- RBAC LOGIC --- */
    function applyRBAC() {
      if(currentUser.role === 'staff') {
        document.getElementById('nav-admin').classList.add('hidden');
        document.getElementById('nav-master').classList.add('hidden');
      }
    }

    function switchTab(tabId, el) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
      
      document.getElementById('tab-' + tabId).classList.add('active');
      if(el) el.classList.add('active');
    }

    /* --- MASTER DATA CRUD --- */
    function loadMasterData() {
      google.script.run.withSuccessHandler(data => {
        masterData = data;
        renderMasterTable();
      }).getMasterData();
    }

    function renderMasterTable() {
      const tbody = document.getElementById('list-master');
      tbody.innerHTML = '';
      masterData.forEach(m => {
        tbody.innerHTML += `
          <tr>
            <td>${m.code}</td>
            <td>${m.name}</td>
            <td>${m.baseUnit}</td>
            <td>${m.altUnit || '-'}</td>
            <td>${m.factor || '-'}</td>
            <td class="${m.stock <= m.minStock ? 'text-danger' : ''}">${m.stock}</td>
            <td>${m.minStock}</td>
            <td>
              ${currentUser.role === 'admin' ? `
              <button class="btn-outline btn-sm" style="padding:4px 8px; font-size:12px; margin-right:5px;" onclick="editMaster('${m.code}')"><i class="ph ph-pencil-simple"></i></button>
              <button class="btn-outline btn-sm" style="padding:4px 8px; font-size:12px; color:var(--danger); border-color:var(--danger);" onclick="deleteMaster('${m.code}')"><i class="ph ph-trash"></i></button>
              ` : '-'}
            </td>
          </tr>
        `;
      });
    }

    function saveMaster() {
      const row = document.getElementById('m-row').value;
      const item = {
        isEdit: row !== '',
        rowIndex: row,
        code: document.getElementById('m-code').value,
        name: document.getElementById('m-name').value,
        baseUnit: document.getElementById('m-base').value,
        altUnit: document.getElementById('m-alt').value,
        factor: parseFloat(document.getElementById('m-factor').value) || 1,
        minStock: parseFloat(document.getElementById('m-min').value) || 0
      };

      if(!item.code || !item.name) return showToast('Kode dan Nama wajib diisi', 'error');

      google.script.run.withSuccessHandler(() => {
        showToast('Data tersimpan', 'success');
        resetMasterForm();
        loadMasterData();
      }).saveMasterItem(item);
    }

    function editMaster(code) {
      const m = masterData.find(x => x.code === code);
      if(!m) return;
      document.getElementById('m-row').value = m.rowIndex;
      document.getElementById('m-code').value = m.code;
      document.getElementById('m-name').value = m.name;
      document.getElementById('m-base').value = m.baseUnit;
      document.getElementById('m-alt').value = m.altUnit;
      document.getElementById('m-factor').value = m.factor;
      document.getElementById('m-min').value = m.minStock;
      document.getElementById('m-code').disabled = true;
    }

    function deleteMaster(code) {
      if(!confirm('Yakin hapus data ini?')) return;
      const m = masterData.find(x => x.code === code);
      google.script.run.withSuccessHandler(() => {
        showToast('Data dihapus', 'success');
        loadMasterData();
      }).deleteMasterItem(m.rowIndex);
    }

    function resetMasterForm() {
      document.getElementById('m-row').value = '';
      document.getElementById('m-code').value = '';
      document.getElementById('m-code').disabled = false;
      document.getElementById('m-name').value = '';
      document.getElementById('m-base').value = '';
      document.getElementById('m-alt').value = '';
      document.getElementById('m-factor').value = '';
      document.getElementById('m-min').value = '';
    }

    /* --- USER MANAGEMENT --- */
    function loadUsers() {
      google.script.run.withSuccessHandler(data => {
        const tbody = document.getElementById('list-users');
        tbody.innerHTML = '';
        data.forEach(u => {
          tbody.innerHTML += `
            <tr>
              <td>${u.username}</td>
              <td><span class="badge ${u.role === 'admin' ? 'badge-in' : 'badge-out'}">${u.role}</span></td>
              <td>
                <button class="btn-outline btn-sm" style="padding:4px 8px; font-size:12px; color:var(--danger); border-color:var(--danger);" onclick="deleteUser('${u.rowIndex}')"><i class="ph ph-trash"></i></button>
              </td>
            </tr>
          `;
        });
      }).getUsers();
    }

    function createUser() {
      const u = document.getElementById('new-u-name').value;
      const p = document.getElementById('new-u-pass').value;
      const r = document.getElementById('new-u-role').value;
      if(!u || !p) return showToast('Isi username & password', 'error');
      
      google.script.run.withSuccessHandler(() => {
        showToast('User dibuat', 'success');
        document.getElementById('new-u-name').value = '';
        document.getElementById('new-u-pass').value = '';
        loadUsers();
      }).createUser({username: u, password: p, role: r, fullname: u});
    }

    function deleteUser(idx) {
      if(!confirm('Hapus user ini?')) return;
      google.script.run.withSuccessHandler(() => loadUsers()).deleteUser(idx);
    }

    /* --- AUTOCOMPLETE & CONVERSION --- */
    function autocomplete(inp) {
      let list = inp.parentElement.querySelector('.autocomplete-items');
      if(list) list.remove();
      
      let val = inp.value;
      if(!val) return;
      
      list = document.createElement('DIV');
      list.setAttribute('class', 'autocomplete-items');
      list.style.position = 'absolute';
      list.style.zIndex = '99';
      list.style.top = (inp.offsetTop + inp.offsetHeight) + 'px';
      list.style.left = inp.offsetLeft + 'px';
      list.style.width = inp.offsetWidth + 'px';
      list.style.background = 'var(--bg-accent)';
      list.style.border = '1px solid var(--border)';
      inp.parentElement.appendChild(list);

      let count = 0;
      masterData.forEach(item => {
        if(item.name.toLowerCase().indexOf(val.toLowerCase()) > -1 && count < 5) {
          let div = document.createElement('DIV');
          div.innerHTML = `<strong>${item.name.substr(0, val.length)}</strong>${item.name.substr(val.length)}`;
          div.innerHTML += `<span style="font-size:12px; color:var(--text-muted); float:right;">Stock: ${item.stock}</span>`;
          div.addEventListener('click', () => {
            inp.value = item.name;
            selectedItem = item;
            setupUnits(item);
            list.remove();
          });
          list.appendChild(div);
          count++;
        }
      });
    }

    function setupUnits(item) {
      const prefix = document.getElementById('tab-keluar').classList.contains('active') ? 'out' : 'in';
      const sel = document.getElementById(prefix + '-unit');
      sel.innerHTML = '';
      
      let opt1 = document.createElement('option');
      opt1.value = item.baseUnit;
      opt1.text = item.baseUnit;
      sel.add(opt1);
      
      if(item.altUnit) {
        let opt2 = document.createElement('option');
        opt2.value = item.altUnit;
        opt2.text = item.altUnit;
        sel.add(opt2);
      }
      
      sel.onchange = () => calcConversion(item);
      
      if(prefix === 'out') {
        document.getElementById('out-stock-display').value = item.stock + ' ' + item.baseUnit;
      }
    }

    function calcConversion(item) {
      const prefix = document.getElementById('tab-keluar').classList.contains('active') ? 'out' : 'in';
      const qty = parseFloat(document.getElementById(prefix + '-qty').value) || 0;
      const unit = document.getElementById(prefix + '-unit').value;
      
      let total = qty;
      let txt = '';
      
      if(unit === item.altUnit && item.factor) {
        total = qty * item.factor;
        txt = `Konversi: ${qty} ${item.altUnit} = ${total} ${item.baseUnit}`;
      } else {
        txt = `Total: ${total} ${item.baseUnit}`;
      }
      
      document.getElementById(prefix + '-conversion-info').innerText = txt;
      return total;
    }

    document.getElementById('in-qty').addEventListener('keyup', (e) => {
      if(selectedItem) calcConversion(selectedItem);
    });
    document.getElementById('out-qty').addEventListener('keyup', (e) => {
      if(selectedItem) calcConversion(selectedItem);
    });

    /* --- TRANSACTION ITEMS --- */
    function addItem(type) {
      if(!selectedItem) return showToast('Pilih barang dulu', 'error');
      
      const prefix = type === 'IN' ? 'in' : 'out';
      const qty = parseFloat(document.getElementById(prefix + '-qty').value);
      const unit = document.getElementById(prefix + '-unit').value;
      
      if(!qty) return showToast('Qty harus diisi', 'error');
      
      let totalBase = (unit === selectedItem.altUnit && selectedItem.factor) ? (qty * selectedItem.factor) : qty;
      
      if(type === 'OUT' && totalBase > selectedItem.stock) return showToast('Stok tidak cukup!', 'error');

      const item = {
        code: selectedItem.code,
        name: selectedItem.name,
        qty: qty,
        unit: unit,
        totalBase: totalBase
      };
      
      if(type === 'IN') tempItemsIN.push(item);
      else tempItemsOUT.push(item);
      
      renderList(type);
      
      document.getElementById(prefix + '-name').value = '';
      document.getElementById(prefix + '-qty').value = '';
      document.getElementById(prefix + '-conversion-info').innerText = '';
      if(prefix === 'out') document.getElementById('out-stock-display').value = '';
      selectedItem = null;
      document.getElementById(prefix + '-name').focus();
    }

    function renderList(type) {
      const list = type === 'IN' ? tempItemsIN : tempItemsOUT;
      const tbody = document.getElementById('list-' + (type === 'IN' ? 'in' : 'out'));
      tbody.innerHTML = '';
      
      list.forEach((item, idx) => {
        tbody.innerHTML += `
          <tr>
            <td>${item.code}</td>
            <td>${item.name}</td>
            <td>${item.qty}</td>
            <td>${item.unit}</td>
            <td>${item.totalBase}</td>
            <td><button class="btn-outline btn-sm" style="padding:2px 6px; color:var(--danger);" onclick="removeItem('${type}', ${idx})">x</button></td>
          </tr>
        `;
      });
    }

    function removeItem(type, idx) {
      if(type === 'IN') tempItemsIN.splice(idx, 1);
      else tempItemsOUT.splice(idx, 1);
      renderList(type);
    }

    function submitTransaction(type) {
      const list = type === 'IN' ? tempItemsIN : tempItemsOUT;
      if(list.length === 0) return showToast('List kosong', 'error');
      
      const header = {
        type: type,
        date: new Date(),
        noRef: type === 'IN' ? document.getElementById('in-ref').value : '-',
        supplier: type === 'IN' ? document.getElementById('in-supplier').value : '-',
        user: currentUser.username
      };
      
      google.script.run.withSuccessHandler(res => {
        if(res.status === 'success') {
          showToast('Transaksi Berhasil', 'success');
          list.length = 0;
          renderList(type);
          loadMasterData();
          loadHistory();
        }
      }).processTransaction(header, list);
    }

    /* --- HISTORY --- */
    function loadHistory() {
      const filters = {
        start: document.getElementById('hist-start').value,
        end: document.getElementById('hist-end').value,
        type: document.getElementById('hist-type').value
      };
      
      google.script.run.withSuccessHandler(data => {
        const tbody = document.getElementById('list-history');
        tbody.innerHTML = '';
        data.forEach(r => {
          let badge = r.type === 'IN' ? 'badge-in' : 'badge-out';
          tbody.innerHTML += `
            <tr>
              <td>${new Date(r.date).toLocaleDateString()}</td>
              <td><span class="badge ${badge}">${r.type}</span></td>
              <td>${r.ref}</td>
              <td>${r.name}</td>
              <td>${r.qtyIn || r.qtyOut}</td>
              <td>${r.stockEnd}</td>
              <td>${r.user}</td>
            </tr>
          `;
        });
      }).getHistory(filters);
    }

    function exportExcel() {
      let table = document.getElementById("tbl-history");
      let html = table.outerHTML;
      let url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
      let link = document.createElement("a");
      link.download = "History.xls";
      link.href = url;
      link.click();
    }

    function showToast(msg, type='success') {
      const t = document.getElementById('toast');
      t.innerText = msg;
      t.className = type === 'error' ? 'error' : '';
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>
